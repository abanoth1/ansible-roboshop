  # creating the catalogue service by using the ansible playbooks 
  - name: creating the catalogue service
    hosts: catalogue
    become: yes
    tasks:
      - name: disable the default nodejs
        ansible.builtin.command: dnf module disable nodejs -y

      - name: enable nodejs 20
        ansible.builtin.command: dnf module enable nodejs:20 -y

      - name: install the nodejs
        ansible.builtin.package:
          name: nodejs
          state: present

      - name: create the roboshop system user # creating the roboshop system user
        ansible.builtin.user:
          name: roboshop
          comment: Roboshop system user
          system: true
          shell: /sbin/nologin
          home: /app
  # ansible is capable of checking the idempotence of the code, we can run the playbook multiple times, it will target the desired state with out any changes

      - name: creating the app directory
        ansible.builtin.file:
          state: directory
          path: /app
          # creating the app directory 

      - name: downloading the catalogue application
        ansible.builtin.get_url:
          url: https://roboshop-artifacts.s3.amazonaws.com/catalogue-v3.zip
          dest: /tmp/catalogue.zip
          # downloadin the catalogue application

      - name: extract the catalogue application 
        ansible.builtin.unarchive:
          src: /tmp/catalogue.zip
          dest: /app
          remote_src: yes

      - name: installing the dependencies
        community.general.npm:
          path: /app

      - name: copying the catalogue service
        ansible.builtin.copy:
          src: catalogue.service
          dest: /etc/systemd/system/catalogue.service

      - name: copy mongo repo
        ansible.builtin.copy:
          src: mongo.repo
          dest: /etc/yum.repos.d/mongo.repo

      - name: install mongodb client
        ansible.builtin.package:
          name: mongodb-mongosh
          state: present

      - name: connect to mongodb catalogue
        ansible.builtin.command: mongosh mongodb.daws86s.me --quiet --eval "db.getMongo().getDBNames().indexOf('catalogue')"
        register: catalogue_output

      # - name: print catalogue output
      #   ansible.builtin.debug:
      #     msg: "{{ catalogue_output}}"

      - name: load the products into mongodb
        ansible.builtin.shell: mongosh --host mongodb.daws86s.me </app/db/master-data.js
        when: catalogue_output.stdout | int < 0
        # making use of | int < 0 to convert the string into integer

      - name: start and enable the catalogue
        ansible.builtlin.service:
          name: catalogue
          state: started
          enabled: yes